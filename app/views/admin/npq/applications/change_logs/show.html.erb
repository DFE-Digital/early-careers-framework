<% content_for :before_content, govuk_back_link(text: 'Back', href: admin_npq_applications_edge_case_path(@npq_application)) %>

<h2 class="govuk-heading-m">Change log</h2>

<% @versions.each_with_index do |version| %>
  <%= govuk_table do |table|
    table.with_caption(size: 's', text: "#{version.created_at.strftime('%d %B %Y %H:%M:%S')}")
    table.with_head do |head|
      head.with_row do |row|
        row.with_cell(header: true, text: 'Field changed', classes: 'govuk-!-width-one-third')
        row.with_cell(header: true, text: 'Changed from', classes: 'govuk-!-width-one-third')
        row.with_cell(header: true, text: 'Changed to', classes: 'govuk-!-width-one-third')
      end
    end

    table.with_body do |body|
      body.with_row do |row|
        row.with_cell(text: 'Last updated by')
        row.with_cell(text: version.previous && User.find_by(id: version.previous.whodunnit).email)
        row.with_cell(text: User.find(version.whodunnit).email)
      end
      if version.object_changes['eligible_for_funding'].present?
        body.with_row do |row|
          row.with_cell(text: 'Eligible')
          row.with_cell(text: version.object_changes.dig('eligible_for_funding', 0))
          row.with_cell(text: version.object_changes.dig('eligible_for_funding', 1))
        end
      end

      if version.object_changes['funding_eligiblity_status_code'].present?
        body.with_row do |row|
          row.with_cell(text: 'Reason if not eligible')
          row.with_cell(text: version.object_changes.dig('funding_eligiblity_status_code', 0))
          row.with_cell(text: version.object_changes.dig('funding_eligiblity_status_code', 1))
        end
      end
    end
  end
  %>
<% end %>

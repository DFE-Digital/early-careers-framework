# frozen_string_literal: true

require "rails_helper"

RSpec.describe Archive::UserPresenter do
  include ArchiveHelper

  let(:id) { SecureRandom.uuid }
  let(:alt_id) { SecureRandom.uuid }
  let(:profile_id) { SecureRandom.uuid }
  let(:trn) { "0012345" }
  let(:user) { build_archived_ect(name: "Adam West", id:, alt_id:, profile_id:, trn:) }
  subject(:presenter) { described_class.new(user.data) }

  describe "#trn" do
    it "returns the TRN from the archive" do
      expect(presenter.trn).to eq trn
    end
  end

  describe "#created_at" do
    it "returns the user creation date" do
      expect(presenter.created_at).to eq Time.zone.parse(user.data.dig("attributes", "created_at"))
    end
  end

  describe "#participant_identities" do
    it "returns the user's identity records" do
      expect(presenter.participant_identities.count).to eq 2
      expect(presenter.participant_identities.first).to be_instance_of Archive::ParticipantIdentityPresenter
      expect(presenter.participant_identities.map(&:id)).to match_array user.data.dig("attributes", "participant_identities").map { |i| i["id"] }
      identities = Archive::ParticipantIdentityPresenter.wrap(user.data.dig("attributes", "participant_identities"))
      expect(presenter.participant_identities.map(&:id)).to match_array identities.map(&:id)
    end
  end
end

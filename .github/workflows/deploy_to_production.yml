name: Deploy to Production

on:
  workflow_dispatch:
    inputs:
      tag:
        description: Git tag to deploy
        required: true

jobs:
  deploy:
    runs-on: ubuntu-20.04
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Fetch tag
        run: |
          git fetch --all --tags
          git checkout tags/${{ github.event.inputs.tag }} # Ensure the tag exists

          echo "HEAD=$(git rev-parse ${{ github.event.inputs.tag }})" >> $GITHUB_ENV

      - name: setup-inputs
        run: |
          INPUTS='${{ format('{{"environment": "production", "ref": "{0}"}}', env.HEAD) }}'
          echo "INPUTS=${INPUTS}" >> $GITHUB_ENV

      - name: trigger-deploy
        uses: benc-uk/workflow-dispatch@v1.1
        with:
          workflow: Deploy to Environment # Workflow name, in deploy.yml
          token: ${{ secrets.PERSONAL_TOKEN }}
          inputs: ${{ env.INPUTS }}
          ref: ${{ env.HEAD }}

      - name: Wait for Deploy App Workflow
        id: wait_for_deploy_app
        uses: fountainhead/action-wait-for-check@v1.0.0
        with:
          token: ${{ secrets.PERSONAL_TOKEN }}
          ref: ${{ env.HEAD }}
          checkName: build docker image and deploy # Job name within workflow
          timeoutSeconds: 900
          intervalSeconds: 15

      - name: Fail if child job fails
        if: ${{ steps.wait_for_deploy_app.outputs.conclusion != 'success' }}
        run: exit 1
